# ProShot 上镜 - 产品需求文档 (PRD)

## 1. 项目愿景

**产品名称：** 上镜 (ProShot)

**一句话介绍：** 电商智能商拍工具，让商品"一键入画"。

**核心价值：** 帮助中小电商卖家（淘宝/拼多多/Shopify）将普通的"人台图"或"平铺图"，低成本转化为高质量的"真人模特/场景化"营销图。

**长期目标：** 从服饰切入，未来拓展至家居、3C等全品类场景生成。

---

## 2. 用户画像

**目标用户：** 缺乏专业摄影预算的电商卖家。

**典型场景：** 用户上传一张衣服挂在塑料模特上的照片，希望立刻得到一张模特穿着这件衣服走在街头的照片。

**核心诉求：** 操作极简（傻瓜式）、衣服还原度高（Logo/版型不乱变）、图片有质感。

---

## 3. 业务流程

### 3.1 首页即工作台

用户进入网站后，**首页即为图片生成页面**，用户可以：
- 无需登录即可上传图片、选择配置、预览界面
- 点击生成时才要求注册/登录
- 注册后即可查看生成结果

### 3.2 功能模块

| 模块 | 描述 | 登录要求 |
|-----|------|---------|
| **服装上身** | 将服装穿到真人模特身上 | 生成时需登录 |
| **多姿势图** | 基于上身图生成 3 张不同姿势的图片 | 需登录 |
| **积分充值** | 购买积分包 | 需登录 |
| **账号设置** | 管理个人信息 | 需登录 |

### 3.3 生成流程

```
上传图片 → 选择场景预设 → 点击"一键上镜"（扣除 1 积分）
    ↓
[未登录] → 弹出登录弹窗 → 完成认证
    ↓
上传原图到 Supabase Storage → 调用 AI 模型 → 展示上身图
    ↓
可选：点击"生成多姿势图"（扣除 5 积分）→ 并行生成 3 张不同姿势 → 展示多姿势图
    ↓
下载高清图
```

**失败处理：** 生成失败时自动退还已扣积分

---

## 4. 详细功能需求

### 4.1 核心生成引擎

**模型调用方式：**
- ⚠️ **所有AI模型调用必须通过 OpenRouter 平台完成**
- OpenRouter 统一支付，便于成本控制和模型切换
- 使用 OpenAI 兼容的 API 格式

**模型配置：**

| 用途 | 模型 | 说明 |
|-----|------|------|
| 上身图生成 | `google/gemini-3.1-flash-image-preview` | 服装上身/物品场景生成 |
| 多姿势图扩展 | `google/gemini-3.1-flash-image-preview` | 多姿势并行生成（3张） |
| 图片扩展（预留） | `google/gemini-2.5-flash-image-preview` | 未来扩展用途 |

**环境变量：**
```env
OPENROUTER_API_KEY=sk-or-xxx        # OpenRouter API密钥
OPENROUTER_API_BASE_URL=https://openrouter.ai/api/v1
```

**Mock 模式（开发调试）：**
- `mockMode`：跳过用户鉴权，便于本地开发测试
- `mockMainImageMode`：跳过 AI 模型调用，返回占位图片

### 4.2 积分系统

| 操作 | 积分消耗/获得 |
|-----|------------|
| 生成上身图 | -1 积分/张 |
| 生成多姿势图 | -5 积分（生成 3 张） |
| 新用户注册 | +6 积分（赠送） |

**积分规则：**
- 积分不足时拒绝生成，提示充值
- 生成失败时自动退还积分
- 所有积分操作均在服务端验证，防止篡改

### 4.2.1 模特分类

**模特类型（4 种）：**

用户在生成上身图前，必须选择一种模特类型（左侧配置栏步骤 2）：

| ID | 名称 | Prompt 描述 |
|----|------|------------|
| `western-female` | 欧美女模特 | 20-28岁欧美女性，深邃立体五官，高挑纤细身材，金棕色头发，时尚大气 |
| `western-male` | 欧美男模特 | 22-32岁欧美男性，轮廓分明面部，强健匀称身材，浅棕或深色头发，阳刚帅气 |
| `asian-female` | 亚洲女模特 | 20-28岁亚洲女性，精致秀丽面容，纤细优雅身材，黑色直发，温柔知性气质 |
| `asian-male` | 亚洲男模特 | 22-32岁亚洲男性，清秀英俊面容，匀称干练身材，黑色整洁头发，时尚有型 |

**默认值：** `asian-female`（亚洲女模特）

**传参方式：** 通过 `modelType` 字段传入 `/api/generate/main`，prompt-builder 据此拼接模特描述。

---

### 4.3 场景预设

**服装场景（5 大类 × 10 细分 = 50 种）：**

场景系统采用二级分类结构，用户先选大类，再选细分场景，并可输入自定义场景描述。

| 大类ID | 大类名称 | 10 个细分场景 |
|--------|---------|--------------|
| `minimal-color` | 极简纯色 | 纯白背景、中性浅灰、燕麦奶色、莫兰迪粉、鼠尾草绿、雾霾灰蓝、复古卡其、深邃纯黑、奶油肌理、大地深咖 |
| `street-style` | 街拍风格 | 繁华十字、宁静小巷、玻璃幕墙、复古红砖、站台通勤、贩卖机旁、斑马线前、树影林荫、街角小店、咖啡店内 |
| `home-scene` | 居家场景 | 原木客厅、榻榻米房、光影窗前、布艺沙发、极简卧室、梳妆台前、纸拉门旁、绿植阳台、岛台厨房、明亮洗漱 |
| `business-office` | 商务办公 | 开放工位、玻璃会议、创意空间、独立办公、气派大堂、休闲沙发、设计工台、明亮茶水、走廊纵深、白板幕布 |
| `outdoor-nature` | 户外自然 | 透光森林、野餐草坪、粼粼湖畔、蔚蓝海滩、玻璃温室、银杏大道、落日海边、冬日雪林、繁花树下、荒野公路 |

**自定义场景输入：** 用户可在固定底栏中输入任意场景描述（如"黄昏雨天"），优先级高于所选预设场景。

**向后兼容：** 旧版 6 种场景 ID（`white-bg`、`street`、`home`、`cafe`、`office`、`outdoor`）在 DB 历史记录中仍可正确解析显示。

**物品场景（预留，4 种）：** 家居展示、桌面摆设、户外展示、商业陈列

### 4.3.1 左侧控制面板布局

左侧配置栏（宽 340px）采用 Flex 纵向布局，分为上下两部分：

**上部分（`flex-1 overflow-y-auto`，可滚动）：**
1. 标题区
2. 上传商品图（card panel）
3. 选择模特类型（card panel）
   - 2×2 Grid 按钮，展示图标 + 名称，选中态高亮主题色
4. 选择拍摄场景（card panel）
   - 一级分类 Tabs：横向滚动胶囊按钮，选中态高亮主题色
   - 二级选项 Grid：2列网格，隐藏垂直滚动条

**下部分（`flex-shrink-0`，固定吸底）：**
1. 自定义场景输入框（`placeholder="可输入自定义场景，例如：黄昏雨天..."`）
2. 「一键上镜」主操作按钮（渐变紫色圆角大按钮）
3. 积分状态提示文字

### 4.4 账号注册

**注册流程（两步）：**
1. 填写邮箱 + 密码（至少 8 位，含字母和数字）+ 确认密码 → 发送邮箱验证码
2. 输入 6 位邮箱验证码 → 完成注册

**注册完成后：**
- 自动创建用户 Profile
- 赠送 6 积分

### 4.5 账号登录

支持以下登录方式：

| 方式 | 说明 |
|-----|------|
| 密码登录 | 邮箱 + 密码 |
| 邮箱验证码登录 | 邮箱 + Supabase Auth OTP（6位码，含倒计时） |

### 4.6 图片管理

**状态机：**
```
Pending → Processing → Completed / Failed
```

**原图处理：**
- 上传前生成 base64 缩略图（持久化显示，避免 blob URL 失效）
- 实际上传到 Supabase Storage，升级为永久 URL
- 生成记录中同时保存原图 URL 和生成图 URL

---

## 5. 技术架构

### 5.1 技术栈

| 层级 | 技术选型 |
|-----|---------|
| **前端框架** | Next.js 14 (App Router) |
| **样式方案** | Tailwind CSS |
| **组件库** | Shadcn/UI |
| **图标库** | Lucide React |
| **数据库** | Supabase (PostgreSQL) |
| **认证** | Supabase Auth（邮箱密码 + OTP + 手机号） |
| **存储** | Supabase Storage |
| **AI接口** | OpenRouter API |
| **测试框架** | Jest + React Testing Library |

### 5.2 UI/UX 设计理念

**视觉风格：** Apple Liquid Glass（苹果液态玻璃）风格

**核心样式类：**
- `.glass-panel`：标准玻璃面板
- `.glass-deep`：深度玻璃（浮层、卡片）
- `.glass-thin`：轻薄玻璃（标签、tooltip）
- `.btn-glow`：发光按钮效果
- `.text-gradient`：渐变文字效果

**色彩系统：**
- 主色调：蓝紫色 `hsl(250, 80%, 60%)`
- 强调色：青色 `hsl(195, 85%, 50%)`
- 背景：深空黑 Deep Space
- 渐变：Purple to Cyan

**字体选择：**
- 标题：Clash Display / Plus Jakarta Sans
- 正文：Inter
- 代码/数字：JetBrains Mono

**交互原则：**
- 即时反馈：所有操作都有视觉/动画反馈（fade-in、scale-in、float、shimmer）
- 渐进式披露：复杂功能逐步展示
- 错误预防：输入验证和确认提示
- Loading 骨架屏：防止认证状态闪烁

---

### 5.3 命名规范

为确保产品文案全局一致，统一采用以下术语：

| 术语类型 | 正确表述 | 禁止使用 |
|---------|---------|---------|
| 服装上身单张图 | **上身图** | 主图 |
| 多姿势扩展图 | **多姿势图** | 套图、多角度图 |

**使用场景：**
- 用户界面文案、弹窗提示、积分说明
- 技术文档、代码注释、测试用例
- API 说明、PRD 文档

---

## 6. 数据库设计

### profiles 表
```sql
id            UUID PRIMARY KEY  -- 关联 auth.users
credits       INT DEFAULT 6     -- 积分余额（新用户默认 6）
is_subscriber BOOLEAN DEFAULT false  -- 是否订阅用户
created_at    TIMESTAMP
updated_at    TIMESTAMP
```

**触发器：** 新用户注册时自动创建 Profile（`handle_new_user`）

### generations 表
```sql
id                  UUID PRIMARY KEY
user_id             UUID REFERENCES profiles(id)
original_image_url  TEXT          -- 原图 URL（Supabase Storage）
generated_image_url TEXT          -- 生成图 URL（可为空）
prompt_used         TEXT          -- 使用的 Prompt
style_preset        TEXT          -- 风格预设（格式: "mode-sceneId"）
mode                TEXT          -- 'clothing' | 'product'
status              TEXT          -- 'pending' | 'completed' | 'failed'
error_message       TEXT          -- 错误信息（可为空）
created_at          TIMESTAMP
updated_at          TIMESTAMP
```

**索引：** `user_id`、`status`、`created_at` 优化查询性能

**安全策略：**
- RLS（Row Level Security）：用户只能访问自己的数据

---

## 7. 页面结构

```
/                   # 首页（工作台）- 服装上身生成 + 生成记录时间线
/pricing            # 积分充值套餐
/about              # 关于页面（使命、技术、隐私）
/(auth)/login       # 登录页（密码登录 + 验证码登录）
/(auth)/register    # 注册页（两步注册流程）
/auth/signout       # 登出路由
```

---

## 8. API 路由设计

### 图片生成

| 路由 | 方法 | 说明 |
|-----|------|------|
| `/api/generate/main` | POST | 生成上身图（扣 1 积分） |
| `/api/generate/multi-pose` | POST | 生成 3 张多姿势图（扣 5 积分） |

### 积分管理

| 路由 | 方法 | 说明 |
|-----|------|------|
| `/api/credits` | GET | 获取积分余额 |
| `/api/credits` | POST | 扣除/增加积分 |

### 生成记录

| 路由 | 方法 | 说明 |
|-----|------|------|
| `/api/generations` | GET | 获取用户的生成记录（倒序） |

### 认证

| 路由 | 方法 | 说明 |
|-----|------|------|
| `/api/auth/callback` | GET | OAuth/Magic Link 回调处理 |

---

## 9. 积分充值套餐

| 套餐 | 积分 | 价格 |
|-----|------|------|
| 基础包 | 50 积分 | ¥49 |
| 专业包 | 200 积分 | ¥159 |
| 企业包 | 500 积分 | ¥349 |

---

## 10. 未来扩展

### 10.1 物品场景图生成（Phase 2）
- 支持家居、3C 产品的场景化
- 更多场景预设：客厅、办公室、户外等
- 支持自定义场景描述

### 10.2 高级功能
- 批量生成
- 自定义模特
- API 开放平台
- 企业团队版

---

## 11. 版本历史

| 版本 | 日期 | 更新内容 |
|-----|------|---------|
| v1.0 | 2024-01 | 初始版本 |
| v2.0 | 2026-01 | 重构版本：优化交互、引入 OpenRouter、更新 UI 设计理念 |
| v2.1 | 2026-02 | 新用户初始积分调整为 6；多姿势图扣费调整为 5 积分/次（生成 3 张）；UI 升级为 Apple Liquid Glass 风格；新增 Jest 单元测试 |
| v2.2 | 2026-02 | 场景预设重构：从 6 种扩展至 5 大类×10 细分共 50 种；左侧面板改为 Flex 吸底布局；新增自定义场景输入；Prompt Builder 支持自定义场景优先；API 路由新增 customScene 参数；新增场景预设 35 条单元测试 |
| v2.3 | 2026-02 | 新增模特分类模块：欧美女、欧美男、亚洲女、亚洲男 4 种可选；左侧配置栏新增步骤 2「选择模特类型」；Prompt Builder 融合模特描述；API 路由新增 modelType 参数 |
| v2.4 | 2026-02 | 上身图生成和多姿势图生成底层模型切换为 `google/gemini-3.1-flash-image-preview` |
