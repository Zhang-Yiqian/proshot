# Dify 工作流快速配置

这是一个简化的配置指南，帮助你快速在 Dify 中设置服饰上身工作流。

## 工作流结构

```
开始 → 提示词构建 → Gemini 2.5 Pro 生图 → 输出
```

---

## 1. 配置输入变量

在「开始」节点添加两个输入：

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `image_url` | 文本 | 白底服装图的URL |
| `scene` | 文本 | 场景描述（由后端自动传入） |

---

## 2. 提示词模板

在 Gemini 2.5 Pro 节点的 **USER Prompt** 中使用：

```
你是一个专业的人像摄影大师和服装造型师。
请根据提供的服装白底图，生成一张模特穿着该服装的高质量照片。

要求：
1. 模特特征：选择合适的亚洲模特（根据服装风格选择性别和体型）
2. 服装还原：服装的款式、颜色、图案、细节必须与原图完全一致
3. 姿态自然：模特姿态优美自然，符合服装风格
4. 光线质感：光线柔和自然，突出服装质感
5. 场景氛围：{{scene}}
6. 图片质量：高清晰度，专业摄影质感

参考服装图：
```

然后在提示词下方添加图片输入，选择变量 `{{image_url}}`

---

## 3. Gemini 2.5 Pro 节点配置

### 模型设置
- **模型**: Gemini 2.5 Pro
- **Temperature**: 0.7
- **Top P**: 0.9
- **输出模态**: 图像

### 图片配置
- **尺寸**: 1024x1536 (或自定义)
- **格式**: URL

---

## 4. 输出配置

在「结束」节点配置输出：

| 输出字段 | 来源 |
|---------|------|
| `image_url` | Gemini节点的图片输出URL |

---

## 5. ProShot 项目配置

### 5.1 配置环境变量

创建 `.env.local` 文件：

```bash
# Dify 配置
DIFY_API_KEY=app-your-api-key
DIFY_API_BASE_URL=https://api.dify.ai/v1
DIFY_WORKFLOW_ID=your-workflow-id

# 开发测试（可选）
NEXT_PUBLIC_MOCK_MODE=true
```

### 5.2 获取 API Key 和 Workflow ID

1. **API Key**: Dify 平台 → 设置 → API 密钥 → 创建
2. **Workflow ID**: 工作流页面 → 发布 → API → 复制 ID

---

## 6. 测试

### Mock 模式测试（无需配置 Dify）

```bash
# 启用 Mock 模式
export NEXT_PUBLIC_MOCK_MODE=true

# 启动开发服务器
npm run dev
```

访问 http://localhost:3000，测试上传和生成功能。

### 真实环境测试

```bash
# 配置真实的 Dify 凭据
# 编辑 .env.local，填入真实的 DIFY_API_KEY 和 DIFY_WORKFLOW_ID

# 关闭 Mock 模式
export NEXT_PUBLIC_MOCK_MODE=false

# 启动
npm run dev
```

---

## 7. 场景参数说明

ProShot 会自动将场景选择转换为描述，传入 Dify：

| 用户选择 | 传入 Dify 的场景描述 |
|---------|---------------------|
| 极简白底 | 纯白背景，极简风格，突出服装细节 |
| 街拍风格 | 都市街头场景，现代时尚风格，自然光线 |
| 居家场景 | 温馨家居场景，舒适自然氛围，柔和光线 |
| 咖啡馆 | 文艺咖啡馆场景，小资情调，温暖灯光 |
| 商务办公 | 商务办公场景，专业职业风格，明亮光线 |
| 户外自然 | 户外自然场景，清新活力，自然阳光 |

---

## 8. 工作流调试技巧

1. **在 Dify 平台先测试**：使用示例图片URL测试工作流
2. **查看日志**：ProShot 控制台会输出详细的调用日志
3. **检查响应格式**：确保 Dify 输出字段名为 `image_url`

---

## 常见问题

**Q: 图片生成失败？**
- 检查 Dify API Key 是否正确
- 确认 Workflow ID 是否匹配
- 查看 Dify 工作流执行日志

**Q: 生成速度慢？**
- Gemini 2.5 Pro 生成需要 30-60 秒
- 可考虑使用 Gemini 2.5 Flash（更快）

**Q: 服装还原不准确？**
- 优化提示词，强调细节保持一致
- 提供更高清的白底图
- 调整 Temperature 参数（降低随机性）

---

完成! 🎉
